Sacchan's Flight and Vehicles Prefab
FOR VRChat SDK3 WITH UDONSHARP: https://github.com/Merlin-san/UdonSharp/releases
Usage instructions below changelog

Contact:
https://discord.gg/Z7bUDc8
https://twitter.com/Sacchan_VRC
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Modularization Update 1.5
Split functionality of EngineController into many different scripts allowing for greater customization
Function dial functions are now each their own script, allowing world creators to code their own
Now using an event system to send events to modular scripts
Added SB-1 hoverbike, SS-1 boat, SC-1 Seaplane, SaccStinger
Now using custom position synchronization code which allows formation flying and better dogfights
Fixed afterburner fuel consumption
Improvements to functionality of many of the now-modular function dial scripts
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Large Update 1.4
Added VTOL functionality and variables
Replaced Afterburner dial function with VTOL Angle
Afterburner now activated by pushing the throttle to max
Added SH-1 helicopter example vehicle
Added SF-1VTOL example vehicle
Textures for SF-1
Adverse Yaw and Roll options
Gun recoil option
Option to totally disable canopy for open cockpit vehicles
Various small optimizations
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.393
Compatibility for VRChat Networking Update
Throttle Now Unaffected by Object Scale
Throttle Sensitivity Option
Inertia Tensor Rotation adjustment Option
Minimum Bomb Drop Delay Option
Some Optimization
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix Update 1.392
Fixed vehicle respawner not setting the 'respawn' animation
Fixed Frontwheel movement
Set AtG render texture to something compatible with quest
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix Update 1.391
Hud lead indicator is now accurate
Made the NotDead event local only
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Large Update 1.39
Added racing objects and scripts
Added simple scoreboard that shows who has the highest kill streak in an instance
Ground Effect added, for much smoother takeoffs, removed Takeoff-assist variables
Replaced hardcoded control surface movement & engine effects with normalized-time animations
Hud almost perfectly synchronized for passengers (airspeed value is not correct if wind is enabled)
Added Bullet drop and corresponding hud prediction
Fixed VelLift variable to function how it was originally intended, so that it works with slower planes
Fixed bug that made the turn rate weaker the higher the refresh rate (removed double-deltatime)
Missiles now have a proximity explode radius option
AAGun updated with missiles and targeting
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.38
Workaround to allow players to hear each other talking in cockpit again (VRChat patch broke it)
Various Functions of the plane are no longer synced using synced variables (Flaps, Gear, Canopy, AB, Hook, Smoking, Missle/Bomb Ammo)
For late joiners things will sync when toggled or the plane respawns.
This should allow for more planes as each plane has less network overhead.
AGM Cam smoothing
Added Russian translation for the guide (Thanks AleksWS)
Various events added to the animator
Fixed Plane using its ground brake in the air when unoccupied, and other physics while unoccupied
No longer required to set up VRChat inputs in Unity, they're only checked in-game now
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.37
Gun Lead Indicator smoother
Missiles reverted to 1.35 because they were much more consistent
Animator events for firing weapons
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.36
Many small tweaks and bugfixes
Added Gun Lead Indicator
Improved missile tracking
Cable snap sound
Missiles unable to lock on through walls
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix Update 1.35
Added missing ViewScreen material
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.34
Added commented out elevon and ruddervator code to EffectsController, uncomment it if you need it.
Added channel number display to ViewScreen
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix Update 1.33
Fixed AoA effects appearing on stationary planes when wind is enabled
Tweaked AAM code to prevent possibility of firing at next target without locking if you fire on the frame target changes
Fixed Throttle Slider animation
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Small Update 1.32
Added plane view screen
Small changes to EffectsController to support view screen
Small fixes to guide images
Bomb angle randomization option
Fair number of small tweaks
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix Update 1.31
Emergency fix to seat exit code to support new VRChat patch
Some tweaks
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Major Update 1.3
VR Motion Controls for Joystick and Throttle
Function Dials with 16 functions for VR control
Air-to-air missiles
Air-to-ground missiles
Bombs
Fuel system
Ammo/Fuel/resupply system and animations
Arresting hook for aircraft carrier landings
Arresting cable prefab
Catapult launch functionality for carrier takeoffs
Catapult prefab
Afterburner
Air/ground brake
Customizable smoke color
Flight limits safety mode
Cruise mode
Altitude hold autopilot
Animated canopy with sound changes
Customizable wind functionality
Takeoff assist options
Sound barrier friction options
Many new sounds
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix 1.21
Fixed plane not exploding in editor test
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Major Changes in 1.2
Huge code changes in this version, back up your projects.
New Lift model, not floaty any more
Customizable lift based on angle of attack, allowing stalls
肘nverts control inputs if plane is moving backwards
Seperate thrust vectoring axis' strength
Square input on control stick, so that controller users don't have disadvantage against keyboard users
'Power' option for control stick for more precise input
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Major Changes in 1.17
Added fully animated HUD
Added mannable AAGun
Improved respawning 
Changed roll behaviour
Many small tweaks and fixes
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix update 1.16
Fixed Respawn button
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Hotfix update 1.15
Fixed sync on Gun firing animation and Flaps animation
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Major Changes in 1.14
Removed other vehicles and attempted to optimized code for SF-1
Added Flares
Smoke is now operated by the pilot
Now makes use of animations for things it makes sense to for, flaps, exploding, gunfire etc.
Smoke effect when damaged
Seat Adjuster
Can no longer destroy your own plane with the machine gun
Renamed AircraftController to SaccAirVehicle
Merged AirplaneGunController into EffectsController
Atmospheric thinning
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Bugfix update 1.13
2 Small bugfixes.
Soundcontroller Sonic boom max distance fix
EffectsController Sea level now always destroys plane
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Bugfix update 1.12
Fixed: Vapor and Wingtrails don't show for people who aren't the owner of the vehicle
Fixed: Bug where respawning vehicles would explode instantly in a loop
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
I Suggest backing up your project before updating.
Major Changes in 1.11
A lot of variable names have changed so you will have to re-input values on most scripts. This was done because I removed RespawnTrigger.
Exploding planes. SF-1 now has HP and takes damage from crashing and getting shot.
I have also shuffled around the hierarchy of the SF-1 to support exploding more easily.
Replaced the respawntrigger with station triggers, and
Replaced the different LeaveButtons with just one
Custom Pitching Moment Setting
Might run a bit faster
Sea Level option on HUDController, plane explodes if you fly below it.
Passenger can make display smoke by holding S or clicking the left thumbstick .
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Changes in 1.1
Huge changes, too much to list. Some features:
Added SF-1 plane
Added SoundController
Doppler effect
Sonic booms
Added EffectsController
Control surface movement
Condensation
Machspeed vapor
Added HudController
Speed
Gs
Altitude
Landing Gear and Flaps status
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Changes in 1.02
Default Airplane Pitch Down Str Ratio changed from .6 to .8
Removed redundant object references in AircraftController.cs
Improved how VehicleRespawnButton.cs works
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Changes in 1.01
Roll now decays much faster in airplanes
Added option to disable thrust vectoring
Implemented (unrealistic) increased lift at higher speeds, you can now fall down faster at low speed
the two above combined should allow for more boring plane physics
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Version 1.5 has the largest changes of any update so far. I intentionally disregarded compatability/ease of update in order to modularize and improve functionality as much as possible.
Updating old projects with custom vehicles will be a challenge. Old animations can be reused but may require some adjustments.
To upgrade old vehicles, i recommend just remaking them. Re-make the animator by copying it from the prefab again and re-add your animations to it.
A number of layers have been removed from the animator and are now done in code.
#Flares (as they are now launched per-click in code)
#DisplaySmoke (it's a simple particle system that is more efficient to toggle in code)
#TrailsGs (Trails are now done in an array in effectscontroller)
#GunAmmo (now done in dfunc code)

Modularization:
EngineController has been renamed to SaccAirVehicle, it and many things it did are now modular scripts
HitDetector is now named SaccEntity, and acts as the central object which contains references and sends events to all modular scripts, as well as handles the function dials
Function dial functions are now each their own script, each referenced by SaccEntity.
Modular scripts that use the event system must be referenced in the SaccEntity's 'Extension Udon Behaviours' array. Function dial scripts are also sent events.
The SaccEntity also sends events related to being picked up, so can be used to make handheld weapons, the SaccStinger is an example of this.

The extension scripts i've written for SaccAirVehicle(SAV_EffectsController, SAV_SoundController) are modular, it's possible to duplicate them, and add your own code to them.
The same is true for SaccAirVehicle. The one caveat being that the AAM Function will not be able to read the target's variables(grounded, etc) if targeting a modified script because it only looks for SaccAirVehicle presently. Waiting for UdonSharp updates to fix this.

Some new modular scripts:
WaterTrigger:
Tells the vehicle when it enters and leaves water
SyncScript:
The new position sync script
KillTracker:
Not required, used to make the KillsBoard work. Can be used without the killboard if you want to use the events that it sends for something else.

Function dials:
SaccEntity has 2 arrays, one for left dial functions, and right dial functions.
Any number of functions can be placed in each array. The code divides the dial up automatically for selection. (Not visually, just for control input)
The order they are input into that array is the order they'll work on the dial, clockwise. First function is in straight up, unless the 'Left/RightDialDivideStraightUp' is ticked, in which case it's to the right of straight up. Look at the difference between the left and right dials in the SF-1 for an example of the difference.
The visuals of the function dial must be set up manually. Look at the dials in the vehicle prefabs in order to understand how.
The MFD.fbx file containts 12 divider meshes for function dials for dials with those number of functions. Named StickDisplay2-12 (the old default, 8, is just named 'StickDisplay')
Function dial scripts contain a 'funcon' (function on) reference if they are toggles. It's the mesh that appears to highlight the function on the dial when it's enabled.
To set the 'funcon' rotations, you can type '360/7' for example, into its Z rotation(if you have 7 functions). Then multiply the result by the dial position -1, then multiply by -1.

The 'Respawn' animation is no longer needed as respawning is handled by delayed events rather than events triggered through an animation.

Due to the new custom position syncing script, more network data is being used, and the maximum limit for number of vehicles has decreased.
The limit is around 12 with default settings, probably more if you increase Update Interval.

================================================================================================================

Inside the /Prefabs folder are individual prefabs for each vehicle, you can place them and they should work right away.

I recommend using CyanEmu to test things inside of Unity editor.

Open the example scene 'SaccFlightExample.unity' to see an example of vehicles set up to work with the Killsboard and racing scripts.

Race set up:
There's an object called RacingTrigger inside the InVehicleOnly/PilotOnly object you can remove this if you don't intend to use it. It should be disabled by default, it's enabled when a race is selected with the racebutton.
The RaceToggleButton has a list of SaccRaceCourseAndScoreBoard objects and toggles through them when interacted with, enables the racingtrigger objects if a race is selected, and tell the racingtriggers to switch to the selected race.
You must place a reference to every Race, and RacingTrigger(for each plane) inside the RaceToggleButton.
Each race has its own script called SaccRaceCourseAndScoreBoard. This contains references for its race's checkpoints, and has text objects for displaying the times.
The RacingTrigger detects checkpoints, tracks your time, and sends your time to the SaccRaceCourseAndScoreBoard script for the selected race when you finish.

Killsboard set up:
Place the killboard anywhere in the world, and drag it into each plane's Killtracker's Kills Board slot

Some of the animations use the 'Motion Time' feature (formerly 'Normalized Time'), which makes the animation be controlled by a float parameter (which is controlled by effectscontroller).
float value 1(or more) = play the last frame of the animation
float value 0(or less) = play the first frame of the animation
and everything in between accordingly.

The MachVapor for example uses the mach10 variable. This variable = 1 at mach10, and 0 when not moving. The animation is 1000 frames long, and the MachVapor is enabled on frame 97 and disabled on frame 102, which corresponds to transitioning mach1.
This variable can be used to do other things like F-14 wings moving back at a certain speed.

The angle of attack variable is 0 at 0 AoA, and 1 at 180.

In Unity play mode without CyanEmu, (and on the VRC Upload screen after build), all vehicles will be controlled at the same time.
You can test fly the vehicles by adding a camera to them. Recommend adding camera as child of the TargetEyeHeight of the PilotSeat.
You can test buttons by clicking Interact in the inspector with the object selected(VehicleRespawner etc), some may crash when tested in the editor.
You can also test the animator variables, but some are set every frame so you won't be able to change them without disabling the script.
To test the gun damage to planes/objects in editor, you must enable the Gun_pilot object, as it's disabled by default (The Interact button on the pilotseat also enables it)
However, it wont hit any other vehicles because they are all set to the onboard vehicle layer because you're controlling them all. I recommend using CyanEmu to test weapons.
As all vehicles will react to inputs in the editor play mode. I recommend disabling vehicles that you aren't testing.
The 'SaccFlight' script will always crash when testing in editor, because it's looking for the VRChat player. This doesnt matter.


Making your own vehicles:

When making a new vehicle, place the prefab that is closest in type to your desired vehicle and Unpack Prefab (not completely) and also unpack prefab on the mesh if necessary. Now your objective is to replace the mesh (PlaneBody on the SF-1) completely.
I recommend just disabling it at first, and placing your mesh just below it on the hierarchy. The first thing you should do is set the VehicleMesh to your new mesh in the SaccAirVehicle script.
Next add colliders to your mesh, any collider types are fine. If your vehicle has wheels, i recommend copying the wheel colliders from the SF-1, and adjusting the size to fit your wheels.
Now go through the entire hierarchy and move all the empties, effects, and sounds to the proper position for your new vehicle.
Finally, duplicate the Animator for the vehicle prefab you used, rename it, place it in a new folder, apply it to your vehicle, and go through each layer and replace any animations that need replacing.
When you're done look at the EffectsController and SoundController, and make sure no array references are empty (the ones that you can change the length of), they're likely to crash if any are.

Tips for modifying basic flight characteristics of aircraft:
If it's having trouble taking off, try adjusting the center of mass and pitch moment positions, as well as the ground effect settings.
The Strength and Friction values for pitch, yaw, and roll are important, and both play off each other. You may need to set them to very high values, especially if you make a large plane.
Rot Multi Max Speed will need to be adjusted for planes with different speeds. It's the speed at which (in meters per second) the plane reaches maximum responsiveness.
Vel Straighten Str Pitch/Yaw are Very important to the handling of the plane. They push the nose toward the velocity direction. (they also interact with pitch and yaw strength)
Lift and Max Lift are also very important, and a bit tricky to tweak. If max lift is too high you can end up with a plane that can fly in circles extremely quickly.
The Vel Lift/Max values are used to prevent the plane's nose from dropping constantly (coutner gravity). Find a Vel Lift Max value that keeps the nose steady, Max is 10 by default but technically should be 9.81 to counter gravity exactly
Vel Lift value is used to decide how quickly the plane reaches Vel Lift Max.
If you make a heavier plane with a greater rigidbody mass value, you will have to tweak all of the values a lot.
Don't change the angular drag or drag of the rigidbody, drag is handled by the script, and angular drag is set by the script as a workaround for a sync issue.

Tips for VTOL Only aircraft:
For helicopters, keep the VTOL Thrust Vec values at 1, and adjust Pitch Yaw and Roll Strength
Pitch Down Lift Strength has a pretty big effect on how fast the vehicle can move forwards
The constant friction values are intended for helicopters (gyroscopic forces stop rotation)
You can make the blade tilt angle larger than implied in order to make the vehicle faster
Set Adverse yaw to 0 if you don't want the helicopter to spin when increasing the throttle
the Vel Straighten values are just as important for the handling of helicopters as planes

This file used to contain explanations of every variable in every script, that information is now contained in the tooltips of the variables. Hold the mouse still over a variable name in unity to see a description of what it does.

The Gun_pilot particle is what does damage to enemy planes. It is set to not collide with reserved2 layer. The plane is set to reserved2 you enter, so that you can't shoot your own plane, and reverted back to previous when you leave.

The hud can be made to appear smaller by moving all children of the 'bigstuff' object +Z local. 'bigstuff' is a child of HudController.

Visual animations are done by either EffectsController directly, HudController if they're local/only when you're in the plane, or through the animator (via values sent to it by EffectsController or modular functions).
Doing animations using the animator is most performant, so I've used it where possible. Some HUD stuff included.
When making a custom plane, you must customize a number of the animations, I recommend duplicating the SF-1's animation controller, and replacing the animations that need replacing.
Likely to need replacing animations:
AAMs
AGMs
Bombs
Brake
CanopyOpen
Explode
FlapsOn
Mach
GearUp
TailHook
TailHookHooked
ThrottleSlider
EngineOutput
EngineOutputAB
Pitch
Yaw
Roll
Remember for animations that are controlled by floats that use motion time, set the animation curves to linear.
Joystick animation is done in the Pitch Yaw and Roll animations. Each one rotates a seperate empty of which the joystick is the last child of.

Hierarchy:
PlaneBody--------
Everything in here is visual, except that it also contains colliders, and wheel colliders. Objects can be placed as children of this if they need to move with parts of it (SS-1)
SaccAirVehicle(formally SaccAirVehicle)--------
Children of this are transforms used by the SaccAirVehicle, and weapon objects for cloning and launching.
EffectsController--------
The children of this are mostly particle systems, visual effects used by EffectsController and the animator.
SoundController--------
The children are all the sounds the plane uses. The AttachedSounds object contains all sounds that are disabled instantly when the plane explodes. The 'beeps' empty contains all the cockpit beep sounds, just move the 'beeps' object instead of all children individually.
InVehicleOnly--------
The children of this are all things that are disabled when you're not inside the plane. Many different objects are in here including the HUD, joystick, MFDs(Multi-Function-Display).
HUDController's 'bigstuff' child object is scaled to 720 to make the hud appear to be on the sky like a real HUD(roughly 1km away). You may want to scale it down to 1 temporarily if you plan on editing HUD elements.
PilotSeat--------
A custom station with seat adjustment code for entering the plane
PassengerSeat--------
AAMs--------
AGMs--------
Bombs--------
These 3 objects just contain meshes to visually represent how many missiles etc you have left. Controlled by the animator.

Custom Layers:
Plane colliders must be set to Walkthrough layer in order to be targeted by AAMs. (Raycast looks for this layer)
Various functions require custom layers to be set up in order to work(Air-to-air-missiles, Air-to-ground custom targets, resupply zones, Arresting cables, and catapults)
As layers can't be imported in a unitypackage you must set them up yourself.
References to the layers will be retained and will work, but they will appear blank until named in Unity. Layers are as follows
23:Hook Cable
24:Catapult
25:AAMTargets
26:AGMTargets
27:Resupply
28:Racing
The trigger objects that you may need to change the layer of are in the prefabs listed below. The plane's AAMTarget is a child of SaccAirVehicle(If it's not, it will not be treated like a vehicle(untargetable on ground etc).
Note that the AAMTarget object on a plane MUST be a first child of the SaccAirVehicle object, or the code to play the radar lock warning tone will fail.

This package also contains a few prefabs that can be used with the vehicles. Explanations follow.

AAMDummyTarget
Target object that can be placed on anything that you want air-to-air missiles to be able to lock on to. MUST be enabled at game start or planes will not detect it during initial target enumeration in Start(). After Start(), it can be disabled to become untargetable.

AGMLockTarget
object that if detected when attempting to lock target close to it with the AGM targeting system, will cause the targeted spot to snap to this location.
The trigger must be on the correct layer, the one selected in the DFUNC_AGM.

Arresting Cable
A prefab containing a cable mesh and a trigger designed to be placed on short runways or aircraft carriers to enable short landings.
The trigger must be on the correct layer, the one selected in the DFUNC_Hook.

Catapult
A prefab containing a catapult mesh and a trigger to enable the plane to launch quickly with no runway
The trigger must be on the correct layer, the one selected in the DFUNC_Catapult.
Catapult launches are controlled by an animation. The point in the animation where the trigger is disabled is the point at which the plane is released.

ResupplyZone
A prefab containing a square outline mesh with a trigger beneath it, used to reload, repair and refuel planes. Remove the mesh and just use the trigger if you want.
The trigger must be on the correct layer, the one selected in the ResupplyTrigger.

Target
A basic example target object with configurable health that respawns, replace with your own mesh to create destroyable buildings, etc. May not sync perfectly.
